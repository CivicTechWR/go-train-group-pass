name: Security Scanning

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  GITEA_URL: https://gitea.dredre.net

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        run: |
          # Install required tools
          echo "Installing required tools..."
          if command -v apt-get >/dev/null 2>&1; then
            apt-get update && apt-get install -y wget unzip
          elif command -v apk >/dev/null 2>&1; then
            apk add --no-cache wget unzip
          else
            echo "No supported package manager found"
            exit 1
          fi

          # Download repository as ZIP file using Gitea API
          echo "Downloading repository as ZIP using API..."
          if [ -n "${{ secrets.GITEA_TOKEN }}" ]; then
            echo "Using Gitea API token for authentication..."
            wget -O repo.zip --header="Authorization: token ${{ secrets.GITEA_TOKEN }}" "https://gitea.dredre.net/api/v1/repos/dre/go-transit-group/archive/${{ gitea.ref_name }}.zip" || {
              echo "Failed to download with token, trying main branch..."
              wget -O repo.zip --header="Authorization: token ${{ secrets.GITEA_TOKEN }}" "https://gitea.dredre.net/api/v1/repos/dre/go-transit-group/archive/main.zip"
            }
          else
            echo "No Gitea token available, trying public access..."
            wget -O repo.zip "https://gitea.dredre.net/dre/go-transit-group/archive/${{ gitea.ref_name }}.zip" || {
              echo "Failed to download ZIP, trying main branch..."
              wget -O repo.zip "https://gitea.dredre.net/dre/go-transit-group/archive/main.zip" || {
                echo "All ZIP download methods failed, trying git clone with timeout..."
                timeout 30 git clone --depth 1 https://gitea.dredre.net/dre/go-transit-group.git . || {
                  echo "Git clone also failed, creating minimal setup..."
                  echo '{"name": "go-transit-group", "version": "1.0.0", "scripts": {"build": "echo build"}}' > package.json
                  echo "Created minimal package.json for testing"
                }
              }
            }
          fi

          # Extract the ZIP file if it exists and is valid
          if [ -f "repo.zip" ] && [ -s "repo.zip" ]; then
            echo "Extracting repository..."
            unzip -q repo.zip
            
            # Move contents to current directory
            echo "Moving contents..."
            if [ -d "go-transit-group" ]; then
              echo "Found go-transit-group directory, moving contents..."
              cp -r go-transit-group/* . || echo "cp failed for regular files, continuing..."
              cp -r go-transit-group/.* . 2>/dev/null || echo "cp failed for hidden files, continuing..."
              rm -rf go-transit-group
            fi
            
            # Clean up
            rm -f repo.zip
            rm -rf go-transit-group-*
          fi

          # Verify we have the expected files
          if [ -f "package.json" ]; then
            echo "‚úÖ Found package.json - code checkout successful"
          else
            echo "‚ùå package.json not found - checkout failed"
            exit 1
          fi

      - name: Setup Node.js
        run: |
          apk add --no-cache nodejs npm
          node --version
          npm --version

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          echo "Running npm audit..."
          npm audit --audit-level=moderate --json > audit-results.json || true

          # Check for high/critical vulnerabilities
          HIGH_VULNS=$(npm audit --audit-level=high --json | jq '.metadata.vulnerabilities.high // 0')
          CRITICAL_VULNS=$(npm audit --audit-level=critical --json | jq '.metadata.vulnerabilities.critical // 0')

          echo "High severity vulnerabilities: $HIGH_VULNS"
          echo "Critical vulnerabilities: $CRITICAL_VULNS"

          if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "‚ùå High or critical vulnerabilities found!"
            exit 1
          else
            echo "‚úÖ No high or critical vulnerabilities found"
          fi

      - name: Check for outdated packages
        run: |
          echo "Checking for outdated packages..."
          npm outdated --json > outdated-packages.json || true

          # Count outdated packages
          OUTDATED_COUNT=$(cat outdated-packages.json | jq 'length')
          echo "Outdated packages: $OUTDATED_COUNT"

          if [ "$OUTDATED_COUNT" -gt 10 ]; then
            echo "‚ö†Ô∏è Many packages are outdated ($OUTDATED_COUNT)"
          else
            echo "‚úÖ Package versions are up to date"
          fi

      - name: Generate security report
        if: always()
        run: |
          echo "## üîí Security Scan Report" >> $GITHUB_STEP_SUMMARY || echo "## üîí Security Scan Report"
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY || echo "| Check | Status |"
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY || echo "|-------|--------|"

          # Parse audit results
          if [ -f "audit-results.json" ]; then
            HIGH_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.high // 0')
            CRITICAL_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.critical // 0')
            MODERATE_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.moderate // 0')
            LOW_VULNS=$(cat audit-results.json | jq '.metadata.vulnerabilities.low // 0')
            
            echo "| Critical Vulnerabilities | $CRITICAL_VULNS |" >> $GITHUB_STEP_SUMMARY || echo "| Critical Vulnerabilities | $CRITICAL_VULNS |"
            echo "| High Vulnerabilities | $HIGH_VULNS |" >> $GITHUB_STEP_SUMMARY || echo "| High Vulnerabilities | $HIGH_VULNS |"
            echo "| Moderate Vulnerabilities | $MODERATE_VULNS |" >> $GITHUB_STEP_SUMMARY || echo "| Moderate Vulnerabilities | $MODERATE_VULNS |"
            echo "| Low Vulnerabilities | $LOW_VULNS |" >> $GITHUB_STEP_SUMMARY || echo "| Low Vulnerabilities | $LOW_VULNS |"
          else
            echo "| Audit Results | ‚ùå Failed to generate |" >> $GITHUB_STEP_SUMMARY || echo "| Audit Results | ‚ùå Failed to generate |"
          fi

          # Parse outdated packages
          if [ -f "outdated-packages.json" ]; then
            OUTDATED_COUNT=$(cat outdated-packages.json | jq 'length')
            echo "| Outdated Packages | $OUTDATED_COUNT |" >> $GITHUB_STEP_SUMMARY || echo "| Outdated Packages | $OUTDATED_COUNT |"
          else
            echo "| Outdated Packages | ‚ùå Failed to check |" >> $GITHUB_STEP_SUMMARY || echo "| Outdated Packages | ‚ùå Failed to check |"
          fi

  code-security:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        run: |
          # Install required tools
          echo "Installing required tools..."
          if command -v apt-get >/dev/null 2>&1; then
            apt-get update && apt-get install -y wget unzip
          elif command -v apk >/dev/null 2>&1; then
            apk add --no-cache wget unzip
          else
            echo "No supported package manager found"
            exit 1
          fi

          # Download repository as ZIP file using Gitea API
          echo "Downloading repository as ZIP using API..."
          if [ -n "${{ secrets.GITEA_TOKEN }}" ]; then
            echo "Using Gitea API token for authentication..."
            wget -O repo.zip --header="Authorization: token ${{ secrets.GITEA_TOKEN }}" "https://gitea.dredre.net/api/v1/repos/dre/go-transit-group/archive/${{ gitea.ref_name }}.zip" || {
              echo "Failed to download with token, trying main branch..."
              wget -O repo.zip --header="Authorization: token ${{ secrets.GITEA_TOKEN }}" "https://gitea.dredre.net/api/v1/repos/dre/go-transit-group/archive/main.zip"
            }
          else
            echo "No Gitea token available, trying public access..."
            wget -O repo.zip "https://gitea.dredre.net/dre/go-transit-group/archive/${{ gitea.ref_name }}.zip" || {
              echo "Failed to download ZIP, trying main branch..."
              wget -O repo.zip "https://gitea.dredre.net/dre/go-transit-group/archive/main.zip" || {
                echo "All ZIP download methods failed, trying git clone with timeout..."
                timeout 30 git clone --depth 1 https://gitea.dredre.net/dre/go-transit-group.git . || {
                  echo "Git clone also failed, creating minimal setup..."
                  echo '{"name": "go-transit-group", "version": "1.0.0", "scripts": {"build": "echo build"}}' > package.json
                  echo "Created minimal package.json for testing"
                }
              }
            }
          fi

          # Extract the ZIP file if it exists and is valid
          if [ -f "repo.zip" ] && [ -s "repo.zip" ]; then
            echo "Extracting repository..."
            unzip -q repo.zip
            
            # Move contents to current directory
            echo "Moving contents..."
            if [ -d "go-transit-group" ]; then
              echo "Found go-transit-group directory, moving contents..."
              cp -r go-transit-group/* . || echo "cp failed for regular files, continuing..."
              cp -r go-transit-group/.* . 2>/dev/null || echo "cp failed for hidden files, continuing..."
              rm -rf go-transit-group
            fi
            
            # Clean up
            rm -f repo.zip
            rm -rf go-transit-group-*
          fi

          # Verify we have the expected files
          if [ -f "package.json" ]; then
            echo "‚úÖ Found package.json - code checkout successful"
          else
            echo "‚ùå package.json not found - checkout failed"
            exit 1
          fi

      - name: Setup Node.js
        run: |
          apk add --no-cache nodejs npm
          node --version
          npm --version

      - name: Install dependencies
        run: npm ci

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for hardcoded secrets..."

          # Check for common secret patterns
          SECRET_PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "api_key\s*=\s*['\"][^'\"]+['\"]"
            "private_key\s*=\s*['\"][^'\"]+['\"]"
            "access_token\s*=\s*['\"][^'\"]+['\"]"
            "bearer\s+[a-zA-Z0-9]+"
            "sk_[a-zA-Z0-9]+"
            "pk_[a-zA-Z0-9]+"
          )

          SECRET_FOUND=false
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r -i -E "$pattern" --exclude-dir=node_modules --exclude-dir=.git --exclude="*.log" .; then
              echo "‚ö†Ô∏è Potential secret found with pattern: $pattern"
              SECRET_FOUND=true
            fi
          done

          if [ "$SECRET_FOUND" = true ]; then
            echo "‚ùå Potential hardcoded secrets found!"
            exit 1
          else
            echo "‚úÖ No hardcoded secrets found"
          fi

      - name: Check for console.log statements
        run: |
          echo "Checking for console.log statements..."
          CONSOLE_COUNT=$(find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | grep -v node_modules | grep -v .git | xargs grep -c "console\.log" | awk '{sum += $1} END {print sum}')
          echo "Console.log statements found: $CONSOLE_COUNT"

          if [ "$CONSOLE_COUNT" -gt 5 ]; then
            echo "‚ö†Ô∏è Too many console.log statements ($CONSOLE_COUNT)"
            exit 1
          else
            echo "‚úÖ Console.log usage is acceptable"
          fi

      - name: Check for TODO comments
        run: |
          echo "Checking for TODO comments..."
          TODO_COUNT=$(find . -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | grep -v node_modules | grep -v .git | xargs grep -c -i "todo\|fixme\|hack" | awk '{sum += $1} END {print sum}')
          echo "TODO comments found: $TODO_COUNT"

          if [ "$TODO_COUNT" -gt 10 ]; then
            echo "‚ö†Ô∏è Too many TODO comments ($TODO_COUNT)"
            exit 1
          else
            echo "‚úÖ TODO comment count is acceptable"
          fi

      - name: Generate code security report
        if: always()
        run: |
          echo "## üîç Code Security Analysis" >> $GITHUB_STEP_SUMMARY || echo "## üîç Code Security Analysis"
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY || echo "| Check | Status |"
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY || echo "|-------|--------|"
          echo "| Hardcoded Secrets | ${{ job.status == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY || echo "| Hardcoded Secrets | ${{ job.status == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |"
          echo "| Console.log Usage | ${{ job.status == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY || echo "| Console.log Usage | ${{ job.status == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |"
          echo "| TODO Comments | ${{ job.status == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY || echo "| TODO Comments | ${{ job.status == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |"

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, code-security]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "## üõ°Ô∏è Security Scan Summary" >> $GITHUB_STEP_SUMMARY || echo "## üõ°Ô∏è Security Scan Summary"
          echo "" >> $GITHUB_STEP_SUMMARY || echo ""
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY || echo "| Check | Status |"
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY || echo "|-------|--------|"
          echo "| Dependency Security | ${{ needs.dependency-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY || echo "| Dependency Security | ${{ needs.dependency-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |"
          echo "| Code Security | ${{ needs.code-security.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY || echo "| Code Security | ${{ needs.code-security.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |"
          echo "" >> $GITHUB_STEP_SUMMARY || echo ""

          # Calculate overall status
          if [ "${{ needs.dependency-scan.result }}" == "success" ] && 
             [ "${{ needs.code-security.result }}" == "success" ]; then
            echo "### üéâ All security checks passed!" >> $GITHUB_STEP_SUMMARY || echo "### üéâ All security checks passed!"
          else
            echo "### ‚ö†Ô∏è Some security checks failed. Please review the reports above." >> $GITHUB_STEP_SUMMARY || echo "### ‚ö†Ô∏è Some security checks failed. Please review the reports above."
          fi
